#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)
require 'gtalkback'
require 'gt_progressbar'

require 'FileUtils'

# TODO: Fix bug where gaps show in the username/message border in the first log_group
# TODO: !!! Make the output handle threaded messages, combining them into one file !!!
# (needed because, when we delete the chats from GMail, the non-chat replies go with.
# Right now they are saved, but written as a seperate file w/o content)
# TODO: Use the chat thread first-received date instead of the last-updated date?
# TODO: Wrte a better WHERE statement that selects only chats (look into using other DB
# fields, like chat_reply_to or whatever)
# TODO: See if we can't get a cleaner snapshot of the database w/o the other non-chat
# items in it.
# TODO: Check into outputting prettier HTML or XHTML (indented)
# TODO: Check into feasability of just using regexs for inout and ERB for output

puts "GMail Chat Backup Utility v1.0"
puts

if (ARGV.length != 2) then
  puts "Error: incorrect number of paramters"
  puts "Usage: chat_extractor.rb database.db ./output_dir"
  abort
end

# TODO: Use more robust argument parsing system
database_file = File.expand_path(ARGV[0])
output_dir = File.expand_path(ARGV[1])

if(File.exist?(output_dir)) then
  abort "Error: Output directory name already in use by a file" if !File.directory?(output_dir)
  abort "Error: unable to write to output directory" if !File.writable?(output_dir)
else
  begin
    Dir.mkdir(output_dir)
  rescue SystemCallError
    abort "Error: Unable to create output directory"
  end
end

# Will not replace an existing style, should it exist
unless File.exist?('style.css') then
  FileUtils.cp(File.expand_path('../../resources', __FILE__) + "/style.css", output_dir + '/style.css')
end

puts "Fethcing and parsing chats . . . "
fetcher = Gtalkback::GTalkFetcher.new(database_file)

fetch_pbar = Gtalkback::ProgressBar.new("Parsing", fetcher.retrieve_number_of_conversations)

fetcher.fetch_records do
  fetch_pbar.inc
end

fetch_pbar.finish